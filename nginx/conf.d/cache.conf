# Caching configuration for optimal performance
# /etc/nginx/conf.d/cache.conf

# Cache zones definition
proxy_cache_path /var/cache/nginx/api 
    levels=1:2 
    keys_zone=api_cache:50m 
    max_size=500m 
    inactive=60m 
    use_temp_path=off;

proxy_cache_path /var/cache/nginx/docs 
    levels=1:2 
    keys_zone=docs_cache:10m 
    max_size=100m 
    inactive=1d 
    use_temp_path=off;

# FastCGI cache (if using PHP in future)
fastcgi_cache_path /var/cache/nginx/fastcgi 
    levels=1:2 
    keys_zone=fastcgi_cache:10m 
    max_size=100m 
    inactive=60m 
    use_temp_path=off;

# Cache key definition
proxy_cache_key "$scheme$request_method$host$request_uri$is_args$args";

# Cache bypass conditions
map $request_method $no_cache {
    POST 1;
    PUT 1;
    DELETE 1;
    default 0;
}

map $http_authorization $auth_no_cache {
    default 1;
    "" 0;
}

# Cache status header
add_header X-Cache-Status $upstream_cache_status always;

# Browser caching for static assets
map $sent_http_content_type $expires {
    default                    off;
    text/html                  1h;
    text/css                   1y;
    application/javascript     1y;
    application/json           10m;
    ~image/                    1M;
    ~font/                     1y;
    application/pdf            1M;
    ~video/                    1M;
}

expires $expires;

# Cache control headers
map $sent_http_content_type $cache_control {
    default                    "public, max-age=0";
    text/html                  "public, max-age=3600, must-revalidate";
    text/css                   "public, max-age=31536000, immutable";
    application/javascript     "public, max-age=31536000, immutable";
    application/json           "public, max-age=600";
    ~image/                    "public, max-age=2592000";
    ~font/                     "public, max-age=31536000, immutable";
    application/pdf            "public, max-age=2592000";
    ~video/                    "public, max-age=2592000";
}

add_header Cache-Control $cache_control always;

# Vary header for proper caching
add_header Vary "Accept-Encoding, Authorization" always;