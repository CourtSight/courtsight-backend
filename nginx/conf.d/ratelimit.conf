# Rate limiting configuration
# /etc/nginx/conf.d/ratelimit.conf

# Define rate limiting zones for different types of requests

# General API rate limiting
limit_req_zone $binary_remote_addr zone=api_general:10m rate=30r/m;

# Authentication endpoints (stricter)
limit_req_zone $binary_remote_addr zone=auth_strict:10m rate=5r/m;

# Chatbot endpoints (AI processing)
limit_req_zone $binary_remote_addr zone=chatbot_ai:10m rate=10r/m;

# File upload endpoints
limit_req_zone $binary_remote_addr zone=upload_files:10m rate=3r/m;

# Search endpoints
limit_req_zone $binary_remote_addr zone=search_api:10m rate=20r/m;

# Admin endpoints (very strict)
limit_req_zone $binary_remote_addr zone=admin_panel:10m rate=10r/h;

# Documentation access
limit_req_zone $binary_remote_addr zone=docs_access:10m rate=60r/m;

# Health check (more lenient)
limit_req_zone $binary_remote_addr zone=health_check:10m rate=120r/m;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=conn_per_ip:10m;
limit_conn_zone $server_name zone=conn_per_server:10m;

# Apply connection limits
limit_conn conn_per_ip 10;
limit_conn conn_per_server 1000;

# Rate limiting status codes
limit_req_status 429;
limit_conn_status 429;

# Custom error page for rate limiting
error_page 429 /429.html;
location = /429.html {
    root /usr/share/nginx/html;
    internal;
}